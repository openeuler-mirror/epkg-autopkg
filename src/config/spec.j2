{% macro when_str_keys(speckey, yamlkey) -%}
{% for condition, values in metadata[yamlkey].items() -%}
{% if condition == '' -%}
{{ speckey }}: {{ values }}
{%- else -%}
{{ parse_when(condition) }}
{{ speckey }}: {{ values }}
{{ print_endif(condition) }}
{% endif -%}
{% endfor -%}
{% endmacro -%}

{% macro when_list_keys(speckey, yamlkey) -%}
{% for condition, values in metadata[yamlkey].items() -%}
{% if condition == '' -%}
{% for value in values -%}
{{ speckey }}: {{ value }}
{% endfor -%}
{%- else -%}
{{ parse_when(condition) }}
{% for value in values -%}
{{ speckey }}: {{ value }}
{% endfor -%}
{{ print_endif(condition) }}
{% endif -%}
{% endfor -%}
{% endmacro -%}

{%- macro bool_value_lower(value) -%}
{%- if value == True -%}
true
{%- else -%}
false
{%- endif -%}
{%- endmacro -%}

{# defineFlags #}
{%- if 'defineFlags' in metadata -%}
{% for condition, values in metadata['defineFlags'].items() -%}
{% if condition == '' -%}
{% for key in values.keys() -%}
{{ key }}
{% endfor -%}
{%- else -%}
{{ parse_when(condition) }}
{% for key in values.keys() -%}
{{ key }}
{% endfor -%}
{{ print_endif(condition) }}
{% endif -%}
{% endfor -%}
{%- endif -%}

{# rpmGlobal #}
{% if 'rpmGlobal' in metadata -%}
{% for name, body in metadata['rpmGlobal'].items() -%}
{% if body is string and body.startswith("%{?") and body.endswith("}") -%}
{%- else -%}
%global {{ name }} {{ body }}
{% endif -%}
{% endfor -%}
{% endif -%}

{# rpmMacros #}
{% if 'rpmMacros' in metadata -%}
{% if '%package' not in metadata['rpmMacros'] -%}
{{ metadata['rpmMacros'] }}
{% endif -%}
{% endif -%}

{# rpmGlobal #}
{% if 'rpmGlobal' in metadata -%}
{% for name, body in metadata['rpmGlobal'].items() -%}
{% if body is string and body.startswith("%{?") and body.endswith("}") -%}
%global {{ name }} {{ body }}
{% endif -%}
{% endfor -%}
{% endif -%}

{# Main info #}
{% if 'name' in metadata -%}
{{ when_str_keys('Name', 'name') }}
{% endif -%}

{% if 'version' in metadata -%}
{{ when_str_keys('Version', 'version') }}
{% endif -%}

{% if 'release' in metadata -%}
{{ when_str_keys('Release', 'release') }}
{% endif -%}

{% if 'summary' in metadata -%}
{{ when_str_keys('Summary', 'summary') }}
{% endif -%}

{% if 'epoch' in metadata -%}
{{ when_str_keys('Epoch', 'epoch') }}
{% endif -%}

{% if 'group' in metadata -%}
{{ when_str_keys('Group', 'group') }}
{% endif -%}

{% if 'license' in metadata -%}
{{ when_str_keys('License', 'license') }}
{% endif -%}

{% if 'buildRoot' in metadata -%}
{{ when_str_keys('BuildRoot', 'buildRoot') }}
{% endif -%}

{% if 'exclusiveArch' in metadata -%}
{{ when_list_keys('ExclusiveArch', 'exclusiveArch') }}
{% endif -%}

{% if 'buildArch' in metadata -%}
{{ when_str_keys('BuildArch', 'buildArch') }}
{% endif -%}

{% if 'prefix' in metadata -%}
{{ when_str_keys('Prefix', 'prefix') }}
{% endif -%}

{% if 'homepage' in metadata -%}
{{ when_str_keys('URL', 'homepage') }}
{% endif -%}

{# source #}
{% if 'source' in metadata -%}
{%- for condition, values in metadata['source'].items() -%}
{%- if condition == '' -%}
{% for num in values -%}
Source{{ num }}: {{ values[num] }}
{% endfor -%}
{%- else -%}
{{ parse_when(condition) }}
{% for num in values -%}
Source{{ num }}: {{ values[num] }}
{% endfor -%}
{{ print_endif(condition) }}
{%- endif -%}
{%- endfor -%}
{% endif -%}

{% if 'includeSource' in metadata -%}
{%- for condition, values in metadata['includeSource'].items() -%}
{%- if condition == '' -%}
{%- for value in values -%}
%include {{ value }}
{%- endfor -%}
{%- else -%}
{{ parse_when(condition) }}
{%- for value in values -%}
%include {{ value }}
{%- endfor -%}
{{ print_endif(condition) }}
{%- endif -%}
{%- endfor -%}
{% endif -%}

{% if 'recommends' in metadata -%}
{{ when_list_keys('Recommends', 'recommends') }}
{% endif -%}

{% if 'excludeArch' in metadata -%}
{{ when_list_keys('ExcludeArch', 'excludeArch') }}
{% endif -%}

{% if 'buildRequires' in metadata -%}
{{ when_list_keys('BuildRequires', 'buildRequires') }}
{% endif -%}

{% if 'suggests' in metadata -%}
{{ when_list_keys('Suggests', 'suggests') }}
{% endif -%}

{% if 'patchset' in metadata -%}
{%- for condition, values in metadata['patchset'].items() -%}
{% if condition == '' -%}
{% for num in values -%}
Patch{{ num }}: {{ values[num] }}
{% endfor -%}
{%- else -%}
{{ parse_when(condition) }}
{% for num in values -%}
Patch{{ num }}: {{ values[num] }}
{% endfor -%}
{{ print_endif(condition) }}
{{ print_endif(condition) }}
{% endif -%}
{%- endfor -%}
{% endif -%}

{% if 'autoReq' in metadata -%}
{{ when_str_keys('AutoReq', 'autoReq') }}
{% endif -%}

{% if 'autoProv' in metadata -%}
{{ when_str_keys('AutoProv', 'autoProv') }}
{% endif -%}

{% if 'autoReqProv' in metadata -%}
{{ when_str_keys('AutoReqProv', 'autoReqProv') }}
{%- endif -%}

{# requires #}
{% if 'requires' in metadata -%}
{{ when_list_keys('Requires', 'requires') }}
{% endif -%}

{% if 'requiresPre' in metadata -%}
{{ when_list_keys('requires(pre)', 'requiresPre') }}
{% endif -%}

{% if 'requiresPost' in metadata -%}
{{ when_list_keys('requires(post)', 'requiresPost') }}
{% endif -%}

{% if 'requiresPreun' in metadata -%}
{{ when_list_keys('requires(preun)', 'requiresPreun') }}
{% endif -%}

{% if 'requiresPostun' in metadata -%}
{{ when_list_keys('requires(Postun)', 'requiresPostun') }}
{% endif -%}

{% if 'requiresPretrans' in metadata -%}
{{ when_list_keys('requires(pretrans)', 'requiresPretrans') }}
{% endif -%}

{% if 'requiresPosttrans' in metadata -%}
{{ when_list_keys('requires(posttrans)', 'requiresPosttrans') }}
{% endif -%}

{# buildConflicts #}
{% if 'buildConflicts' in metadata -%}
{{ when_list_keys('BuildConflicts', 'buildConflicts') }}
{% endif -%}

{# Provides #}
{% if 'provides' in metadata -%}
{{ when_list_keys('Provides', 'provides') }}
{% endif -%}

{# Conflicts #}
{% if 'conflicts' in metadata -%}
{{ when_list_keys('Conflicts', 'conflicts') }}
{% endif -%}

{# Obsoletes #}
{% if 'obsoletes' in metadata -%}
{{ when_list_keys('Obsoletes', 'obsoletes') }}
{% endif -%}

{# description #}
{% if 'description' in metadata -%}
%description
{{ metadata['description'][''] }}
{% endif -%}

{# appliedMacros #}
{% if 'appliedMacros' in metadata -%}
{{ metadata['appliedMacros'][''] }}
{%- endif -%}

{# rpmMacros #}
{% if 'rpmMacros' in metadata -%}
{% if '%package' in metadata['rpmMacros'] -%}
{{ metadata['rpmMacros'] }}
{% endif -%}
{% endif -%}

{% macro data_when_str_keys(speckey, yamlkey, data) -%}
{% for condition, values in data[yamlkey].items() -%}
{%- if condition == '' -%}
{{ speckey }}:    {{ values }}
{% else -%}
{{ parse_when(condition) }}
{{ speckey }}:    {{ values }}
{{ print_endif(condition) }}
{%- endif -%}
{% endfor -%}
{% endmacro -%}

{%- macro data_when_list_keys(speckey, yamlkey, data) -%}
{% for condition, values in data[yamlkey].items() -%}
{%- if condition == '' -%}
{% for value in values -%}
{{ speckey }}: {{ value }}
{% endfor -%}
{%- else -%}
{{ parse_when(condition) }}
{% for value in values -%}
{{ speckey }}: {{ value }}
{% endfor -%}
{{ print_endif(condition) }}
{%- endif -%}
{% endfor -%}
{%- endmacro -%}

{%- macro parse_subpackage(packagename, values) -%}
%package -n {{ packagename }}
{% if 'summary' in values -%}
{{ data_when_str_keys('Summary', 'summary', values) }}
{% endif -%}

{% if 'buildArch' in values -%}
{{ data_when_str_keys('BuildArch', 'buildArch', values) }}
{% endif -%}

{# rpmMacros #}
{% if 'rpmMacros' in values -%}
{{ values['rpmMacros'][''] }}
{% endif -%}

{% if 'license' in values -%}
{{ data_when_str_keys('License', 'license', values) }}
{% endif -%}

{% if 'group' in values -%}
{{ data_when_str_keys('Group', 'group', values) }}
{% endif -%}

{% if 'version' in values -%}
{{ data_when_str_keys('Version', 'version', values) }}
{% endif -%}

{% if 'release' in values -%}
{{ data_when_str_keys('Release', 'release', values) }}
{% endif -%}

{% if 'epoch' in values -%}
{{ data_when_str_keys('Epoch', 'epoch', values) }}
{% endif -%}

{% if 'homepage' in values -%}
{{ data_when_str_keys('URL', 'homepage', values) }}
{% endif -%}

{# patchset #}
{% if 'patchset' in values -%}
{%- for condition, value in values['patchset'].items() -%}
{%- if condition == '' -%}
{%- for num in value -%}
Patch{{ num }}: {{ value[num] }}
{%- endfor -%}
{%- else -%}
{{ parse_when(condition) }}
{%- for num in values -%}
Patch{{ num }}: {{ values[num] }}
{%- endfor -%}
{{ print_endif(condition) }}
{%- endif -%}
{%- endfor -%}
{% endif -%}

{% if 'prefix' in values -%}
{{ data_when_str_keys('Prefix', 'prefix', values) }}
{% endif -%}

{% if 'NoAutoReq' in values -%}
AutoReq:    0
{% endif -%}

{% if 'NoAutoProv' in values -%}
AutoProv:   0
{% endif -%}

{% if 'NoAutoReqProv' in values -%}
AutoReqProv:    0
{% endif -%}

{% if 'orderWithRequires' in values -%}
{{ data_when_list_keys('OrderWithRequires', 'orderWithRequires', values) }}
{% endif -%}

{% if 'requires' in values -%}
{{ data_when_list_keys('Requires', 'requires', values) }}
{% endif -%}

{% if 'recommends' in values -%}
{{ data_when_list_keys('Recommends', 'recommends', values) }}
{% endif -%}

{% if 'suggests' in values -%}
{{ data_when_list_keys('Suggests', 'suggests', values) }}
{% endif -%}

{% if 'requiresPre' in values -%}
{{ data_when_list_keys('Requires(pre)', 'requiresPre', values) }}
{% endif -%}

{% if 'requiresPost' in values -%}
{{ data_when_list_keys('Requires(post)', 'requiresPost', values) }}
{% endif -%}

{% if 'requiresPreun' in values -%}
{{ data_when_list_keys('Requires(preun)', 'requiresPreun', values) }}
{% endif -%}

{% if 'requiresPostun' in values -%}
{{ data_when_list_keys('Requires(Postun)', 'requiresPostun', values) }}
{% endif -%}

{% if 'requiresPretrans' in values -%}
{{ data_when_list_keys('Requires(pretrans)', 'requiresPretrans', values) }}
{% endif -%}

{% if 'requiresPosttrans' in values -%}
{{ data_when_list_keys('Requires(posttrans)', 'requiresPosttrans', values) }}
{% endif -%}

{# Provides #}
{% if 'provides' in values -%}
{{ data_when_list_keys('Provides', 'provides', values) }}
{% endif -%}

{# Conflicts #}
{% if 'conflicts' in values -%}
{{ data_when_list_keys('Conflicts', 'conflicts', values) }}
{% endif -%}

{# Obsoletes #}
{% if 'obsoletes' in values -%}
{{ data_when_list_keys('Obsoletes', 'obsoletes', values) }}
{% endif -%}

{# buildRequires #}
{% if 'buildRequires' in values -%}
{{ data_when_list_keys('BuildRequires', 'buildRequires', values) }}
{% endif -%}

{# BuildConflicts #}
{% if 'buildConflicts' in values -%}
{{ data_when_list_keys('BuildConflicts', 'buildConflicts', values) }}
{% endif -%}

{# AutoReq #}
{% if 'autoReq' in values -%}
AutoReq: {{ bool_value_lower(values['autoReq']['']) }}
{% endif -%}

{% if 'autoProv' in values -%}
AutoProv: {{ bool_value_lower(values['autoProv']['']) }}
{% endif -%}

{% if 'autoReqProv' in values -%}
AutoReqProv: {{ bool_value_lower(values['autoReqProv']['']) }}
{% endif -%}

{# description #}
{% if 'description' in values -%}
%description -n {{ packagename }}
{{ values['description'][''] }}
{% endif -%}
{% endmacro -%}

{# subpackage #}
{% if 'subpackage' in metadata -%}
{%- for packagename in metadata['subpackage'] -%}
{%- set sub_values = metadata['subpackage'][packagename] -%}
{%- for condition, values in sub_values.items() -%}
{%- if condition == '' -%}
{{ parse_subpackage(packagename, values) }}
{%- else -%}
{{ parse_when(condition) }}
{{ parse_subpackage(packagename, values) }}
{{ print_endif(condition) }}
{%- endif -%}
{%- endfor -%}
{%- endfor -%}
{% endif -%}

{% macro print_script(script_name) -%}
{%- if script_name in metadata -%}
{%- for item in metadata[script_name] -%}
{%- if item['condition'] == '' -%}
%{{ script_name }} {{ item['param'] }}
{% if script_name == 'files' -%}
{{ print_value(item['value']) }}
{% else -%}
{{ item['value'] }}
{% endif -%}
{%- else -%}
{{ parse_when(item['condition']) }}
%{{ script_name }} {{ item['param'] }}
{% if script_name == 'files' -%}
{{ print_value(item['value']) }}
{% else -%}
{{ item['value']|trim }}
{% endif -%}
{% if script_name == 'files' -%}
{% if script_name in metadata -%}
{{ print_endif(item['condition']) }}
{% endif -%}
{%- else -%}
{{ print_endif(item['condition']) }}
{% endif -%}
{% endif -%}
{%- endfor -%}
{%- endif -%}
{% endmacro -%}

{# Build scriptlets #}
{% set build_scripts = ['prep', 'build', 'install', 'check', 'clean'] -%}
{%- for script in build_scripts -%}
{%- if script in metadata -%}
{{ print_script(script) }}
{%- endif -%}
{% endfor -%}

{%- macro print_trigger(trigger_name) -%}
{%- if trigger_name in metadata -%}
{%- for item in metadata[trigger_name] -%}
{%- if item['condition'] == '' -%}
%{{ trigger_name }} {{ item['param'] }}
{{ item['value'] }}
{%- else -%}
{{ parse_when(item['condition']) }}
%{{ trigger_name }} {{ item['param'] }}
{{ item['value'] }}
{{ print_endif(item['condition']) }}
{%- endif -%}
{%- endfor -%}
{%- endif -%}
{%- endmacro -%}

{# scripts #}
{% set runtime_scripts = ['pre', 'preun', 'pretrans', 'preuntrans', 'post', 'postun', 'posttrans', 'postuntrans', 'verify'] -%}
{%- for script in runtime_scripts -%}
{%- if script in metadata -%}
{{ print_script(script) }}
{%- endif -%}
{%- endfor -%}

{# triggers #}
{% set runtime_triggers = ['triggerprein', 'triggerin', 'triggerun', 'triggerpostun', 'filetriggerin', 'filetriggerun', 'filetriggerpostun', 'transfiletriggerin', 'transfiletriggerun', 'transfiletriggerpostun'] -%}
{%- for trigger in runtime_triggers -%}
{%- if trigger in metadata -%}
{{ print_trigger(trigger) }}
{%- endif -%}
{%- endfor -%}

{# files #}
{% if 'files' in metadata -%}
{{ print_script('files') }}
{% endif -%}

{# changelog #}
{% if changelog != '' -%}
%changelog
{{ changelog }}
{% endif -%}
